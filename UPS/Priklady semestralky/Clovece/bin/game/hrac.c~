#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <netinet/in.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>
#include <semaphore.h>
#include "struktury.h"
#include "server.h"
#include "stats.h"
#include "hra.h"
#include "clovece.h"
#include "hrac.h"


char *barvy[4];
hrac_t *hraci = NULL;
pthread_mutex_t mutex_hraci;

void inicializuj_barvy()
{
	barvy[0] = malloc(sizeof(char)*4);
	strcpy(barvy[0], "zel");
	barvy[1] = malloc(sizeof(char)*4);
	strcpy(barvy[1], "cer");
	barvy[2] = malloc(sizeof(char)*4);
	strcpy(barvy[2], "zlu");
	barvy[3] = malloc(sizeof(char)*4);
	strcpy(barvy[3], "mod");
}

void uvolni_barvy()
{
	int i;
	for(i = 0; i < POCET_HRACU; i++)
	{
		free(barvy[i]);
		barvy[i] = NULL;
	}
}

void zrus_hrace(hrac_t *hrac)
{
	if(!hrac)
		return;

	char *id = malloc(20*sizeof(char));
	strcpy(id, hrac -> ID);
	int socket = hrac -> socket;
	int shut = hrac -> shut;
	char *log = malloc(100 * sizeof(char));
	sprintf(log, "Odpojil se hrac ID = %s\n", hrac -> ID);
	
	pthread_mutex_lock(&mutex_hraci);
	hrac_t *ptr = hraci;
	hrac_t *predchozi = NULL;
	do
	{
		if(strcmp(ptr -> ID, id)==0)
		{
			if(!predchozi && ptr -> dalsi == NULL)
			{
				vymaz_hrace(ptr);
				hraci = NULL;
			}
			else if(ptr -> dalsi)
			{
				hraci = ptr -> dalsi;
				vymaz_hrace(ptr);
				ptr = NULL;
			}
			else{
				predchozi -> dalsi = ptr -> dalsi;
				vymaz_hrace(ptr);
				ptr = NULL;
			}
			break;
				
		}
		predchozi = ptr;
		ptr = ptr -> dalsi;
	}while(ptr != NULL);

	pthread_mutex_unlock(&mutex_hraci);
	char *zprava = malloc(sizeof(char)*50);
	sprintf(zprava, "%s;konec\n", id);	
	if(shut != 1)
		odesli(socket, zprava);

	zapis_log(log);
	free(log);

	free(zprava);
	free(id);
}

void vymaz_hrace(hrac_t *hrac)
{
	free(hrac-> ID);	
	free(hrac-> jmeno);
	int i;	
	for(i = 0; i < POCET_FIGUREK; i++)
	{
		free((hrac -> figurky)[i]);
	}
	free(hrac);
}

hrac_t *najdi_hrace(char *id)
{
	if(!id)
		return NULL;

	pthread_mutex_lock(&mutex_hraci);
	if(hraci != NULL)
	{
		hrac_t *ptr = hraci;
		do
		{
			if(strcmp(ptr -> ID, id) == 0)
			{
				pthread_mutex_unlock(&mutex_hraci);
				return ptr;
			}
			ptr = ptr -> dalsi;
		}while(ptr != NULL);
	}
	pthread_mutex_unlock(&mutex_hraci);
	return NULL;
}

void pridej_hrace(hrac_t *hrac)
{
	
	if(!hrac)
		return;	
	
	pthread_mutex_lock(&mutex_hraci);
	if(hraci == NULL)
	{
		hraci = hrac;
	}
	else 
	{
		hrac_t *ptr = hraci;
		while(ptr -> dalsi != NULL)
		{
			ptr = ptr -> dalsi;
		}
		ptr -> dalsi = hrac;
				
	}
	pthread_mutex_unlock(&mutex_hraci);
}

void udelej_figurky(hrac_t *hrac)
{
	if(hrac != NULL)
	{
		int i = 0;
		for(; i < POCET_FIGUREK; i++)
		{
			figurka_t *figurka = malloc(sizeof(figurka_t));
			figurka -> pocet_posunu = 0;
			figurka -> index = -1;
			(hrac -> figurky)[i] = figurka;	
		}	
	
	}
}

hrac_t *vytvor_hrace(int socket, char *jmeno)
{
	hrac_t *hrac = malloc(sizeof(hrac_t));
	hrac -> jmeno = malloc(50*sizeof(char));
	hrac -> socket = socket;
	hrac -> shut = 0;
	strcpy(hrac -> jmeno,jmeno);
	hrac -> ID = generuj_ID();
	hrac -> dalsi = NULL;
	hrac -> hra = NULL;
	udelej_figurky(hrac);
	return hrac;
}

void uklid_hrace()
{
	while(hraci)
	{
		zrus_hrace(hraci);
	}
}
